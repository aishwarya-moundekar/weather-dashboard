<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vatavaraan — Cloud-Powered Weather Intelligence • Aishwarya Moundekar</title>
  <meta name="description" content="Vatavaraan — Cloud-Powered Weather Intelligence. Live forecasts via Open-Meteo. Deployed on GitHub Pages.">
  <!-- Favicon placeholder: paste a 48x48 PNG at /favicon.png or update URL -->
  <link rel="icon" href="/favicon.png" type="image/png">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-1:#fffafc; --bg-2:#f7fcff; --muted:#64748b;
      --accent-a:#ffd6e0; --accent-b:#e6f7ff; --accent-c:#fff5cc;
      --card-glass: rgba(255,255,255,0.9);
      --text:#0f172a;
      --radius:14px;
    }
    [data-theme="dark"]{
      --bg-1:#071021; --bg-2:#072235; --muted:#9fb4c8; --card-glass: rgba(8,12,20,0.7); --text:#e6eef8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2)); padding:28px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{ max-width:980px; margin:0 auto; position:relative; z-index:1; }

    /* blobs */
    .blobs{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .blob{ position:absolute; filter: blur(30px); opacity:.65; border-radius:50%; transform:translate3d(0,0,0); animation: float 12s ease-in-out infinite; }
    .blob.a{ width:380px; height:380px; background:linear-gradient(135deg,var(--accent-a),var(--accent-c)); left:-80px; top:-70px; }
    .blob.b{ width:320px; height:320px; background:linear-gradient(135deg,var(--accent-b),var(--accent-c)); right:-90px; top:30px; }
    .blob.c{ width:260px; height:260px; background:linear-gradient(135deg,#e9ffe6,var(--accent-a)); left:18%; bottom:-110px; }
    @keyframes float{ 0%{transform:translateY(0)}50%{transform:translateY(-20px)}100%{transform:translateY(0)} }

    .card{ background: linear-gradient(180deg,var(--card-glass), rgba(255,255,255,0.85)); border-radius:20px; padding:18px; box-shadow:0 12px 34px rgba(15,23,42,0.06); border:1px solid rgba(255,255,255,0.4); margin-bottom:14px; }

    header.top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title{ display:flex; gap:12px; align-items:center; }
    .logo{ width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; background:linear-gradient(135deg,var(--accent-c),var(--accent-a)); box-shadow:0 6px 20px rgba(20,20,40,0.06); }
    h1{ margin:0; font-size:20px; }
    .subtitle{ margin-top:2px; font-size:13px; color:var(--muted); }

    .controls{ margin-top:14px; display:flex; gap:10px; align-items:center; }
    .search{ flex:1; display:flex; gap:8px; align-items:center; }
    input[type="text"]{ flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(15,23,42,0.06); background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.85)); font-size:14px; }
    input[type="text"]:focus{ outline:none; box-shadow:0 10px 30px rgba(37,99,235,0.06); transform:translateY(-1px); }

    .btn{ padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:700; background:linear-gradient(180deg,#a8e3ff,#7fc8ff); color:#06385a; box-shadow:0 8px 20px rgba(37,99,235,0.12); }
    .btn.secondary{ background:linear-gradient(180deg,#ffe6f5,#ffd6e0); color:#6a2241; box-shadow:0 6px 18px rgba(233,46,149,0.06); }

    .meta{ margin-top:10px; display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .chip{ padding:8px 10px; border-radius:999px; background:linear-gradient(180deg,#fff,#fff); border:1px solid rgba(15,23,42,0.04); box-shadow:0 6px 14px rgba(12,18,40,0.03); cursor:pointer; font-size:13px; }
    .chip:hover{ transform:translateY(-3px); }

    .main{ display:none; padding:14px; border-radius:14px; }
    .place{ font-weight:700; font-size:18px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .stat{ flex:1; min-width:160px; border-radius:12px; padding:12px; background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8)); box-shadow:0 8px 22px rgba(20,20,40,0.04); transition:transform .12s ease; }
    .stat:hover{ transform:translateY(-6px); }
    .small{ color:var(--muted); font-size:13px }
    .large{ font-size:22px; font-weight:700; margin-top:6px }
    .hourly{ margin-top:12px; display:flex; gap:10px; overflow:auto; padding-bottom:8px; }
    .hour{ min-width:120px; padding:10px; border-radius:12px; background:var(--card-glass); border:1px solid rgba(15,23,42,0.03); box-shadow:0 8px 20px rgba(12,18,40,0.04); cursor:pointer; }
    .hour:hover{ transform:translateY(-6px); }

    .hour .time{ font-size:12px; color:var(--muted); }
    .hour .icon{ font-size:20px; margin-top:8px; }
    .hour .t{ font-weight:700; margin-top:8px; }
    .hour .p{ font-size:12px; color:var(--muted); margin-top:6px; }

    .chartwrap{ margin-top:16px; border-radius:12px; padding:10px; background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8)); box-shadow:0 8px 22px rgba(12,18,40,0.04); }

    .loader { display:inline-block; width:18px; height:18px; border-radius:50%; border:3px solid rgba(15,23,42,0.06); border-top-color:#7fc8ff; animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px; }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .error{ margin-top:12px; color:#7a1f1f; background:linear-gradient(180deg,#fff8f8,#fff); padding:10px; border-radius:10px; border:1px solid rgba(255,110,110,0.12) }

    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:12px; }

    /* small responsive */
    @media (max-width:720px){ .logo{ width:48px; height:48px; } .stat{ min-width:140px } }
  </style>
</head>
<body>
  <div class="blobs" aria-hidden="true"><div class="blob a"></div><div class="blob b"></div><div class="blob c"></div></div>

  <div class="container">
    <div class="card">
      <header class="top">
        <div class="title">
          <div class="logo" aria-hidden="true">☁️</div>
          <div>
            <h1>Vatavaraan</h1>
            <div class="subtitle">Cloud-Powered Weather Intelligence</div>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <div style="font-size:13px; color:var(--muted)">Units</div>
          <div><button id="unitToggle" class="btn secondary">°C</button></div>
          <div><button id="themeToggle" class="btn secondary">Dark</button></div>
        </div>
      </header>

      <div class="controls">
        <div class="search">
          <input id="q" placeholder="City name or lat,lon (e.g., Nagpur or 21.15,79.09)" />
          <button id="go" class="btn">Get Weather</button>
        </div>
      </div>

      <div class="meta">
        <div id="status" style="display:flex; gap:8px; align-items:center; color:var(--muted)"><span id="busy" style="display:none"><span class="loader"></span>Loading…</span></div>
        <div style="flex:1"></div>
        <div style="font-size:13px; color:var(--muted)">Recent</div>
      </div>
      <div class="chips" id="recent"></div>
    </div>

    <div id="main" class="card main">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="place" id="place">—</div>
          <div id="summary" class="small" style="margin-top:6px"></div>
        </div>
        <div style="text-align:right">
          <div class="small">Last updated</div>
          <div id="last" style="font-weight:700"></div>
        </div>
      </div>

      <div class="row">
        <div class="stat">
          <div class="small">Temperature</div>
          <div class="large" id="temp">--</div>
        </div>
        <div class="stat">
          <div class="small">Wind</div>
          <div class="large" id="wind">--</div>
        </div>
        <div class="stat">
          <div class="small">Precipitation</div>
          <div class="large" id="prec">--</div>
        </div>
      </div>

      <div style="margin-top:12px; font-weight:700; color:var(--muted)">Hourly (next 24h)</div>
      <div id="hourly" class="hourly"></div>

      <div class="chartwrap" style="margin-top:10px">
        <canvas id="chart" height="80"></canvas>
      </div>

      <footer>© 2025 • Vatavaraan — Cloud-Powered Weather Intelligence • Built by Aishwarya Moundekar • Deployed on GitHub Pages</footer>
    </div>

    <div id="err" class="error" style="display:none"></div>
  </div>

<script>
/* ---------- Utilities & state ---------- */
let unit = 'C'; // C or F
const recentKey = 'vatavaraan-recent';
const maxRecent = 6;

function cToF(c){ return (c*9/5)+32; }
function fmtTemp(v){ if(v==null||isNaN(v)) return '--'; return unit==='C' ? `${v.toFixed(1)}°C` : `${cToF(v).toFixed(1)}°F`; }
function setBusy(on){ document.getElementById('busy').style.display = on ? 'inline-flex' : 'none'; }
function showError(msg){ const e = document.getElementById('err'); e.style.display='block'; e.textContent = msg; setBusy(false); document.getElementById('main').style.display='none'; }

/* ---------- recent localStorage ---------- */
function getRecent(){ try{ const s=localStorage.getItem(recentKey); return s?JSON.parse(s):[] }catch(e){return[]} }
function addRecent(q){ if(!q) return; let a=getRecent(); a=a.filter(x=>x.toLowerCase()!==q.toLowerCase()); a.unshift(q); if(a.length>maxRecent) a=a.slice(0,maxRecent); localStorage.setItem(recentKey,JSON.stringify(a)); renderRecent(); }
function renderRecent(){ const wrap=document.getElementById('recent'); wrap.innerHTML=''; const list=getRecent(); if(!list.length){ wrap.innerHTML='<div style="color:var(--muted)">no recent searches</div>'; return } list.forEach(q=>{ const d=document.createElement('div'); d.className='chip'; d.textContent=q; d.onclick=()=>{ document.getElementById('q').value=q; doSearch(); }; wrap.appendChild(d); }) }
renderRecent();

/* ---------- weathercode to icon mapping ---------- */
const weatherIcons = {
  0:'☀️',1:'🌤️',2:'⛅',3:'☁️',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌦️',55:'🌧️',
  56:'🌨️',57:'🌧️',61:'🌧️',63:'🌧️',65:'🌧️',66:'🌨️',67:'🌨️',71:'❄️',73:'❄️',
  75:'❄️',77:'❄️',80:'🌦️',81:'🌧️',82:'🌧️',85:'❄️',86:'❄️',95:'⛈️',96:'⛈️',99:'⛈️'
};
function iconFor(code){ return weatherIcons[code] || '☁️' }

/* ---------- geocode + fetch (Open-Meteo) ---------- */
async function geocode(q){
  try{
    // tolerant lat,lon detection (accept "19.2474,73.1373" or "19.2474 73.1373")
    const latlon = String(q).trim().match(/^\s*([+-]?\d+(?:\.\d+)?)\s*[,\s]\s*([+-]?\d+(?:\.\d+)?)\s*$/);
    if(latlon){
      const lat = parseFloat(latlon[1]);
      const lon = parseFloat(latlon[2]);
      console.log('geocode: parsed coords', lat, lon);
      return { lat, lon, name: `${lat.toFixed(4)}, ${lon.toFixed(4)}` };
    }

    // otherwise call Open-Meteo geocoding
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1`;
    console.log('geocode: calling', url);
    const res = await fetch(url);
    if(!res.ok) throw new Error('Geocoding API returned status ' + res.status);
    const json = await res.json();
    if(!json || !json.results || json.results.length === 0) throw new Error('Location not found');
    const first = json.results[0];
    const display = `${first.name}${first.admin1? ', '+first.admin1 : ''}${first.country? ', '+first.country : ''}`;
    console.log('geocode: resolved to', display, first.latitude, first.longitude);
    return { lat: first.latitude, lon: first.longitude, name: display };
  } catch(err){
    console.error('geocode error:', err);
    throw err;
  }
}



async function fetchWeather(lat, lon){
  // If you want to proxy through serverless for logging or to avoid rate limits, call your /api/fetchWeather endpoint instead (see serverless example)
  const params = new URLSearchParams({
    latitude: lat, longitude: lon,
    hourly:'temperature_2m,precipitation,weathercode',
    current_weather:'true', timezone:'auto'
  });
  const url = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Weather API error');
  return r.json();
}

/* ---------- UI render ---------- */
let chartInstance = null;
function renderPlace(name){ document.getElementById('place').textContent = name; }
function renderSummary(text){ document.getElementById('summary').textContent = text; }
function renderMain(data, placeName){
  document.getElementById('err').style.display='none';
  document.getElementById('main').style.display='block';
  renderPlace(placeName);
  const now = new Date(); document.getElementById('last').textContent = now.toLocaleString();

  const cw = data.current_weather || {};
  const temp = cw.temperature ?? (data.hourly?.temperature_2m?.[0] ?? null);
  const wind = cw.windspeed ?? null;
  const prec = data.hourly?.precipitation?.[0] ?? null;

  document.getElementById('temp').textContent = fmtTemp(temp);
  document.getElementById('wind').textContent = (wind!=null? `${wind.toFixed(1)} km/h` : '--');
  document.getElementById('prec').textContent = (prec!=null? `${prec.toFixed(2)} mm` : '--');

  // hourly cards
  const hv = document.getElementById('hourly'); hv.innerHTML='';
  const hrs = data.hourly;
  const labels = []; const temps = [];
  if(hrs && hrs.time){
    for(let i=0;i<24 && i<hrs.time.length;i++){
      const t = hrs.time[i].replace('T',' ');
      const tmp = hrs.temperature_2m[i];
      const p = hrs.precipitation[i];
      const wc = hrs.weathercode ? hrs.weathercode[i] : null;
      const card = document.createElement('div'); card.className='hour';
      card.innerHTML = `<div class="time">${t}</div><div class="icon">${iconFor(wc)}</div><div class="t">${fmtTemp(tmp)}</div><div class="p">P:${p? p.toFixed(2):'0'} mm</div>`;
      card.onclick = ()=>{ // toggle extra
        const ex = card.querySelector('.extra'); if(ex) ex.remove(); else { const e=document.createElement('div'); e.className='extra'; e.style.marginTop='8px'; e.style.color='var(--muted)'; e.textContent = `Weather code: ${wc ?? 'n/a'}`; card.appendChild(e); }
      };
      hv.appendChild(card);
      labels.push(t.split(' ')[1]); temps.push(tmp);
    }
  }

  // draw chart
  const ctx = document.getElementById('chart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Temperature', data:temps, fill:true, tension:0.3, borderWidth:2 }] }, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:false } } } });

}

/* ---------- main search flow ---------- */
async function doSearch(fromGeo=false){
  const q = document.getElementById('q').value.trim();
  if(!q && !fromGeo){ showError('Please enter a city or coordinates'); return; }
  setBusy(true); document.getElementById('main').style.display='none'; document.getElementById('err').style.display='none';
  try{
    const g = await geocode(q || '');
    const w = await fetchWeather(g.lat, g.lon);
    renderMain(w, g.name);
    addRecent(q || `${g.lat},${g.lon}`);
    // Optional: send log to serverless (see serverless example). uncomment when you have /api/log endpoint
    // fetch('/api/log', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({query:q||'', lat:g.lat, lon:g.lon, when: new Date().toISOString()}) });
    setBusy(false);
  }catch(e){
    showError(e.message || 'Unknown error');
  }
}

// Direct search using numeric coordinates — bypasses geocoding
async function doSearchCoords(lat, lon, displayName){
  setBusy(true);
  document.getElementById('main').style.display = 'none';
  document.getElementById('err').style.display = 'none';
  try {
    const w = await fetchWeather(lat, lon);
    // use the provided displayName (if any) else show lat,lon
    const name = displayName || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    renderMain(w, name);
    addRecent(name);
    setBusy(false);
  } catch(e) {
    showError(e.message || 'Unknown error (coords)');
  }
}


/* ---------- UI events ---------- */
document.getElementById('go').addEventListener('click', ()=>doSearch());
document.getElementById('q').addEventListener('keydown',(e)=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('unitToggle').addEventListener('click', ()=>{
  unit = (unit==='C')? 'F' : 'C'; document.getElementById('unitToggle').textContent = (unit==='C'?'°C':'°F'); // re-render last query
  const last = document.getElementById('q').value.trim(); if(last) doSearch();
});
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme'); const next = cur === 'dark' ? '' : 'dark';
  document.documentElement.setAttribute('data-theme', next); document.getElementById('themeToggle').textContent = (next==='dark'?'Light':'Dark');
});

/* ---------- geolocation quick-get ---------- */
if(navigator.geolocation){
  const geoBtn = document.createElement('button');
  geoBtn.className = 'btn secondary';
  geoBtn.style.marginLeft = '6px';
  geoBtn.textContent = 'Use my location';
  geoBtn.onclick = ()=>{
    setBusy(true);
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      // ensure we use plain ASCII comma and decimal dot
      const lat = Number(pos.coords.latitude);
      const lon = Number(pos.coords.longitude);
      // set the input display (optional)
      document.getElementById('q').value = `${lat.toFixed(4)},${lon.toFixed(4)}`;
      // call the direct coords search (bypasses geocoding)
      await doSearchCoords(lat, lon, `${lat.toFixed(4)}, ${lon.toFixed(4)}`);
    }, (err)=>{
      showError('Location denied or unavailable');
    });
  };
  document.querySelector('.search').appendChild(geoBtn);
}


/* ---------- initial demo ---------- */
document.getElementById('q').value='Nagpur';
doSearch();
</script>
</body>
</html>
